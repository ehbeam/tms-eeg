
<!DOCTYPE html>

<html>

  <head>

    <title>TMS-EEG Data Viewer</title>
    
    <!-- <link rel="stylesheet" type="text/css" href="style.css"> -->
    
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <style>

      body {
        font-family: Avenir;
        margin: 45px;
      }

      h1 {
        font-family: Superclarendon;
        font-size: 28px;
      }

      button {
        border-radius: 8px;
        border-color: black;
        margin: 5px;
        cursor: pointer;
      }

      button:focus {
        outline: none;
      }

      select {
        font-weight: normal;
        border-radius: 5px;
        background: white;
        border-color: black;
        margin: 5px;
        cursor: pointer;
      }

      select:focus {
        outline: none;
      }

      text {
        font-family: Avenir;
        font-size: 12px;
      }

      #group-container {
        width: 750px;
      }

      #group-toolbar {
        display: inline-block;
        width: 708px;
        border-radius: 10px;
        background: #E5E5E5;
        padding: 5px;
        padding-top: 10px;
        padding-bottom: 10px;
        border-color: black;
        border-style: solid;
        border-width: 1px;
        margin-left: -4px;
        margin-right: 10px;
        text-align: left;
      }

      .group {
        padding: 0px;
        padding-bottom: -20px;
      }

      .group-label {
        margin-left: 22px;
        margin-right: 22px;
        font-weight: bold;
      }

      .group-select-label {
        font-style: normal;
        margin-left: 0px;
        margin-right: 3px;
      }

      .group-select {
        width: 140px;
        margin-left: 3px;
        margin-right: 20px;
      }

      .group-color {
        display: inline-block;
        height: 24px;
        width: 24px;
        border-radius: 5px;
        background: blue;
        opacity: 0.5;
        margin-left: 5px;
        margin-right: 20px;
        margin-bottom: -7px;
      }

      #group-button {
        font-size: 18px;
        display: inline-block;
        background: #E5E5E5;
        padding-left: 9px;
        padding-right: 9px;
        margin-left: -2px;
        margin-right: -5px;
      }

      #group-button:focus {
        outline: none;
        background: gray;
        font-style: bold;
      }

      #data-toolbar {
        width: 750px;
        border-radius: 10px;
        background: #E5E5E5;
        padding: 5px;
        padding-top: 10px;
        padding-bottom: 10px;
        border-color: black;
        border-style: solid;
        border-width: 1px;
        text-align: left;
      }

      .data-label {
        margin-left: 22px;
        margin-right: 2px;
        text-align: left;
      }

      .data-select {
        width: 278px;
        margin-left: 3px;
        margin-right: 3px;
      }

    </style>

  </head>
    
  <body>
        
    <center>

      <h1>TMS-EEG Data Viewer</h1><br/>

      <div id="group-container">

        <div id="group-toolbar">
        
          <div class="group" id="group-1" style="display:inline-block;">
            <span class="group-label">Group 1</span><span class="group-select-label">Project:</span><select id="project-1" class="group-select"></select><span class="group-select-label">Condition:</span><select id="condition-1" class="group-select"></select><span class="group-select-label">Color:</span><div class="group-color" id="color-1"></div><span id="n-1"><i>N</i> = 0</span>
          </div>

          <div class="group" id="group-2" style="display:none;">
            <span class="group-label">Group 2</span><span class="group-select-label">Project:</span><select id="project-2" class="group-select"></select><span class="group-select-label">Condition:</span><select id="condition-2" class="group-select"></select><span class="group-select-label">Color:</span><div class="group-color" id="color-2"></div><span id="n-2"><i>N</i> = 0</span>
          </div>

          <div class="group" id="group-3" style="display:none;">
            <span class="group-label">Group 3</span><span class="group-select-label">Project:</span><select id="project-3" class="group-select"></select><span class="group-select-label">Condition:</span><select id="condition-3" class="group-select"></select><span class="group-select-label">Color:</span><div class="group-color" id="color-3"></div><span id="n-3"><i>N</i> = 0</span>
          </div>

          <div class="group" id="group-4" style="display:none;">
            <span class="group-label">Group 4</span><span class="group-select-label">Project:</span><select id="project-4" class="group-select"></select><span class="group-select-label">Condition:</span><select id="condition-4" class="group-select"></select><span class="group-select-label">Color:</span><div class="group-color" id="color-4"></div><span id="n-4"><i>N</i> = 0</span>
          </div>

          <div class="group" id="group-5" style="display:none;">
            <span class="group-label">Group 5</span><span class="group-select-label">Project:</span><select id="project-5" class="group-select"></select><span class="group-select-label">Condition:</span><select id="condition-5" class="group-select"></select><span class="group-select-label">Color:</span><div class="group-color" id="color-5"></div><span id="n-5"><i>N</i> = 0</span>
          </div>

        </div>

        <button id="group-button">+</button><br/><br/>

      </div>

      <div id="data-toolbar">

        <label class="data-label">X Data:</label><select class="data-select" id="x-data"></select>
        
        <label class="data-label">Y Data:</label><select class="data-select" id="y-data"></select>
      
      </div><br/>

      <div id="plot"></div>

    </center>

  <!-- Modal -->
    <div class="modal fade" id="myModal" role="dialog" data-keyboard="false" data-backdrop="static">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Deleting Point</h4>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to remove the point?</p>
          </div>
          <div class="modal-footer">
                  <button id="btn-no-delete" type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                  <button id="btn-yes-delete" type="button" class="btn btn-danger btn-ok">Delete</button>
          </div>
        </div>
      </div>
    </div>
          
    <script>

      var file = "data/TMS-EEG_Cohen_PAINT_All.csv";

      d3.csv(file, function(data){

        var vars = Object.keys(data[0]);
        var categoricalVars = ["Project", " Subject", " Condition"];
        var continuousVars = [""].concat(vars.filter(v => !categoricalVars.includes(v)));
        var varIDs = ["x-data", "y-data"];

        function loadSelect(id, text) {
          var select = document.getElementById(id);
          var option = document.createElement("option")
          option.text = text;
          select.add(option);
        }

        for (var i = 0; i < continuousVars.length; i++) {
          for (var j = 0; j < varIDs.length; j++) {
            loadSelect(varIDs[j], continuousVars[i])
          }
        }

        function extractUnique(arr) {
          var unique = [];
          for (var i = 0; i < arr.length; i++) {
            if (!unique.includes(arr[i])) { unique.push(arr[i]) };
          } 
          return unique;
        }

        var projects = [""]; var conditions = [""];
        for (var i = 0; i < data.length; i++) {
          projects.push(data[i]["Project"])
          conditions.push(data[i][" Condition"])
        }
        projects = extractUnique(projects);
        conditions = extractUnique(conditions);

        for (var i = 1; i < 6; i++) {
          for (var j = 0; j < projects.length; j++) {
            loadSelect("project-" + i, projects[j])
          }
          for (var k = 0; k < conditions.length; k++) {
            loadSelect("condition-" + i, conditions[k])
          }
        }
        
        var nGroups = 1;

        function addGroupToolbar() {
          if (nGroups < 5) {
            nGroups = nGroups + 1;
            document.getElementById("group-" + nGroups).style.display = "inline-block";
          }
        }

        d3.select("#group-button")
          .on("click", addGroupToolbar)

        function randomData(samples, num) {
          let newData = [];
          let name = "group-" + num;
          for (i = 1; i < samples; i++) {
            newData.push({
              x: i,
              y: i+10*Math.random(),
              name: name
            });
          }

          newData.sort(function(a, b) {
            return a.x - b.x;
          })
         
          return {key: name, values: newData};
        }

        var data = [];

        for(let i = 0; i < 2; i++) {
          data[i] = randomData(16,i);
        }


        // Set Color Scale
        let color = d3.scaleOrdinal(d3.schemeCategory20);

        var scales = {
              'Linear': d3.scaleLinear(),
              'Power': d3.scalePow().exponent(2),
              'Log': d3.scaleLog(),
              'Sqrt': d3.scaleSqrt()
            }
            
        var zoom = d3.zoom().on('zoom', zoomed);
         $('#myModal').modal('hide');

        /********************** Turn off Toggle Confirm ****************/
        var isConfirm = true;
        d3.select("#toggleConfirm").on('click', function() {
          isConfirm = !isConfirm
          
          if (!isConfirm) {
            d3.select(this).text('Turn On Confirm');
          } else {
            d3.select(this).text('Turn Off Confirm');
          }
        })
         
        /*********************** Set Plot Elements *********************/
        var margin = {
          top: 20,
          right: 50,
          bottom: 50,
          left: 60
        };

        var width = 775 - margin.left - margin.right,
          height = 400 - margin.top - margin.bottom;

        let xExtent = findExtent(data, 'x');
        let yExtent = findExtent(data, 'y');
          
        var xScale = d3.scaleLinear()
          .range([0, width])
          .domain(xExtent).nice();

        var yScale = d3.scaleLinear()
          .range([height, 0])
          .domain(yExtent).nice();

        var xAxis = d3.axisBottom(xScale).ticks(12),
          yAxis = d3.axisLeft(yScale).ticks(12 * height / width);

        var plotLine = d3.line()
          .curve(d3.curveMonotoneX)
          .x(function(d) {
            return xScale(d.x);
          })
          .y(function(d) {
            return yScale(d.y);
          });

        var svg = d3.select("#plot").append("svg")
           .attr("width", width + margin.left + margin.right)
           .attr("height", height + margin.top + margin.bottom);

        svg.append("text")   
            .attr("id", "x-label")          
            .attr("transform",
                  "translate(" + (width / 2 + margin.left) + " ," + 
                                 (height + margin.top + 42) + ")")
            .style("text-anchor", "middle")
            .text("");

        svg.append("text")
            .attr("id", "y-label")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left + 70)
            .attr("x", 0 - (height / 2) - 15)
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .text(""); 

        function updateVars() {

          var xEl = document.getElementById("x-data");
          var xVar = xEl.options[xEl.selectedIndex].value;
          d3.selectAll("#x-label").text(xVar);

          var yEl = document.getElementById("y-data");
          var yVar = yEl.options[yEl.selectedIndex].value;
          d3.selectAll("#y-label").text(yVar);

        }

        d3.select("#x-data")
          .on("change", updateVars)
        d3.select("#y-data")
          .on("change", updateVars)     

        // make a clip path
        svg.append("defs").append("clipPath")
              .attr("id", "clip")
              .append("rect")
              .attr("width", width)
              .attr("height", height);
              
        var zoomWindow = svg.append("rect")
          .attr("clip-path", "url(#clip)")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
          .attr("width", width)
          .attr("height", height)
          .style("opacity", 1)
          .style("fill", "white");
          
        svg.append("g")
          .attr("class", "x axis ")
          .attr('id', "axis--x")
          .attr("transform", "translate(" + margin.left + "," + (height + margin.top) + ")")
          .call(xAxis);

        svg.append("g")
          .attr("class", "y axis")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
          .attr('id', "axis--y")
          .call(yAxis);
          
        var line = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        var dot = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        zoomWindow.call(zoom);

        update();

        /****************** Update Below **************************/
        d3.select("#addData").on('click', newRandom);

        var g = 1;

        function newRandom() {
          let newData = [];

          for (i = 1; i < 15; i++) {
            newData.push({
              x: g,
              y: g+10*Math.random(),
              name: "group-2"
            });
            
            g++;
          }
          
          if(data.length === 2) {
            data.push({key: 'group-2', values: newData});
          } else {
            data[2].values = data[2].values.concat(newData);
          }
          
          data.forEach(el => {
            el.values.sort(function(a,b) {
              return a.x - b.x;
            })
          });
            
            update();
        }

        function findExtent(arr, prop) {
          var max = d3.max(arr, function(array) {
            let values = array.values;
            return d3.max(values, function(v) {return v[prop];});
          });
          
          var min = d3.min(arr, function(array) {
            let values = array.values;
            return d3.min(values, function(v) {return v[prop];});
          });
          
          return [min, max]
        }

        function update() {

          let xExtent = findExtent(data, 'x');
          let yExtent = findExtent(data, 'y');
          
          // Adjust scale's domain whenver new data is added
          xScale.domain(xExtent).nice();
          yScale.domain(yExtent).nice();
          
          // Rescale to zoom's scale
          let t = d3.zoomTransform( zoomWindow.node());
          let new_yScale = t.rescaleY(yScale); 
          let new_xScale = t.rescaleX(xScale);
          
          // Adjust plotline generator
          plotLine = d3.line()
          .curve(d3.curveMonotoneX)
          .x(function(d) {
            return new_xScale(d.x);
          })
          .y(function(d) {
            return new_yScale(d.y);
          });
          
          // Adjust axis labels
          yAxis.scale(new_yScale);
          xAxis.scale(new_xScale);
          
          svg.transition().duration(750).select('.y.axis').call(yAxis);
          svg.transition().duration(750).select('.x.axis').call(xAxis);


          // Add and update to plot data
        data.forEach(function (d, i) {

          if(d3.select("#line-"+i).empty()) {
                //add new charts
                // Add line plot
              line.append("g")
                  .attr("id", "line-" + i)
                  .attr("clip-path", "url(#clip)")
                    .append("path")
                    .data([d.values])
                    .attr("class", "pointlines")
                    .attr("d", plotLine)
                    .style("fill", "none")
                    .style("stroke", function () {
                        return d.color = color(d.key);
                    });;

              dot.append("g")
                .attr("id", "scatter-" + i)
                .attr("clip-path", "url(#clip)")
                .selectAll(".dot")
                .data(d.values)
                  .enter().append("circle")
                  .attr("class", "dot")
                  .attr("r", 5)
                  .attr("cx", function(d) {
                    return new_xScale(d.x);
                  })
                  .attr("cy", function(d) {
                    return new_yScale(d.y);
                  })
                  .attr("stroke", "white")
                  .attr("stroke-width", "2px")
                  .style("fill", function() {
                    return d.color = color(d.key);
                  })
                  .on("click", function(d,i) {
                    let s = d3.select(this);
                    remove(s,i, d.name);
                  });
                  
          } else {
              let lineSelect = line.select("#line-"+i).select("path").data([d.values]);
              
              lineSelect.transition().duration(750)
                .attr("d", plotLine);

              //Update all circles
              let scatterSelect = dot.select("#scatter-"+i).selectAll("circle").data(d.values);
              
              scatterSelect.transition()
                .duration(750)
                .attr("cx", function(d) {
                  return new_xScale(d.x);
                })
                .attr("cy", function(d) {
                  return new_yScale(d.y);
                })
                .attr("stroke", "white")
                .attr("stroke-width", "2px")
                .style("fill", function() {
                  return d.color = color(d.key);
                 });

              //Enter new circles
              scatterSelect.enter()
                .append("circle")
                  .attr("cx", function(d) {
                    return new_xScale(d.x);
                  })
                  .attr("cy", function(d) {
                    return new_yScale(d.y);
                  })
                  .attr("r", 5)
                  .attr("stroke", "white")
                  .attr("stroke-width", "2px")
                  .style("fill", function() {
                    return d.color = color(d.key);
                  })
                  .on("click", function(d,i) {
                    let s = d3.select(this);
                    remove(s,i, d.name);
                  });

              // Remove old
              scatterSelect.exit().remove()
            }
        });

        }

          
        function modalConfirm(callback){
              $("#myModal").modal('show')
              
              $("#btn-yes-delete").on("click", function(){
                callback(true);
                $("#myModal").modal('hide');
              });

              $("#btn-no-delete").on("click", function(){
                callback(false);
                $("#myModal").modal('hide');
              });
         };

        function remove(sel, index, name) {
          
          if (isConfirm) {
            modalConfirm(function(confirm){
              if(confirm){
                $("#btn-no-delete").off();
                $("#btn-yes-delete").off();

                console.log("Removing point at: " + name + ": values[" + index + "]")
                data.forEach(el => {
                  if(el.key === name) {
                    el.values.splice(index,1);
                  }
                });

                update();
              }else{
                $("#btn-no-delete").off();
                $("#btn-yes-delete").off();
                console.log("NOT DELETING");
                return;
              }
            });
          } else {
            console.log("Removing point at: " + name + ": values[" + index + "]")
                data.forEach(el => {
                  if(el.key === name) {
                    el.values.splice(index,1);
                  }
                });
                
            update();
          }
        }

        /************ Change Scales ****************************/
        d3.select("#x-scales").on('change', setXScale); 
        d3.select("#y-scales").on('change', setYScale);
        d3.select("#resetScales").on("click", resetScales);

        var xChoice = 'Linear', yChoice = 'Linear';
        function setXScale() {
          xChoice = this.value;
          setScales();
        }

        function setYScale() {
          yChoice = this.value;
          setScales();
        }


        function resetScales() {
          d3.select("#x-scales").node().value = 'Linear';
          d3.select("#y-scales").node().value = 'Linear';
          xChoice = 'Linear';
          yChoice = 'Linear';
          setScales();
        }

        function setScales() {
          
          xScale = scales[xChoice].copy();
          yScale = scales[yChoice].copy();
          
          xScale.range([0, width]);
          yScale.range([height, 0]);
          
          // update plot
          update();
        }

        /****************** Reset plot ***********************************/
        d3.select("#resetPlot").on('click', resetPlot);

        function resetPlot() {
          zoomWindow.transition().duration(750)
             .call(zoom.transform, d3.zoomIdentity);
        }
                    
        /****************** Zoom Function ********************************/
        function zoomed() {
                // Update Scales
                let new_yScale = d3.event.transform.rescaleY(yScale);
                let new_xScale = d3.event.transform.rescaleX(xScale);
                
                // re-scale axes
                svg.select(".y.axis")
                    .call(yAxis.scale(new_yScale));

                svg.select(".x.axis")
                    .call(xAxis.scale(new_xScale));

                // re-draw line
                plotLine = d3.line()
                    .curve(d3.curveMonotoneX)
                    .x(function (d) {
                        return new_xScale(d.x);
                    })
                    .y(function (d) {
                        return new_yScale(d.y);
                    });

                line.selectAll('path').attr("d", plotLine);
                
                d3.selectAll('circle')
                  .attr("cx", function(d) {
                    return new_xScale(d.x);
                  })
                  .attr("cy", function(d) {
                    return new_yScale(d.y);
                  });
        }
    });

    </script>


  </body>

</html>